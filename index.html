<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Population Projection Calculator - Dark Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Modern Dark Mode Color Variables */
      :root {
        --color-background-body: #121212;
        --color-background-card: #1e1e1e;
        --color-text-primary: #e0e0e0;
        --color-text-secondary: #b3b3b3;
        --color-accent: #00bcd4; /* Cyan/Teal for modern look */
        --color-accent-hover: #00a4b8;
        --color-border: #333333;
        --color-input-bg: #2d2d2d;
        --color-result-item-bg: #282828;
        --color-shadow: rgba(0, 0, 0, 0.5);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 30px 20px;
        background-color: var(--color-background-body);
        color: var(--color-text-primary);
        line-height: 1.6;
      }

      .calculator,
      .results,
      .chart-container {
        background: var(--color-background-card);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--color-shadow);
        margin-bottom: 25px;
        transition: box-shadow 0.3s ease;
      }

      h1,
      h2 {
        color: var(--color-accent);
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 10px;
        margin-top: 0;
      }

      p {
        color: var(--color-text-secondary);
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 1rem;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        box-sizing: border-box;
        background-color: var(--color-input-bg);
        color: var(--color-text-primary);
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      input:focus {
        border-color: var(--color-accent);
        outline: none;
      }

      button {
        width: 100%;
        background-color: var(--color-accent);
        color: var(--color-background-card);
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.1s;
      }

      button:hover {
        background-color: var(--color-accent-hover);
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      .result-item {
        margin: 12px 0;
        padding: 15px;
        background: var(--color-result-item-bg);
        border-left: 5px solid var(--color-accent);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .result-item strong {
        font-weight: 600;
      }

      .result-item span {
        font-weight: bold;
        color: var(--color-accent);
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <h1>Population Projection Calculator</h1>
      <p>
        This tool projects population change using Total Fertility Rate (TFR),
        Life Expectancy, and Median Age. It models population aging and births
        directly â€” no crude birth/death rates are used.
      </p>

      <div class="input-group">
        <label for="initialPopulation">Initial Population:</label>
        <input
          type="text"
          id="initialPopulation"
          value="300,000,000"
          data-number-value="300000000"
        />
      </div>

      <div class="input-group">
        <label for="tfr">Total Fertility Rate (children per woman):</label>
        <input type="number" id="tfr" value="2.1" step="0.1" min="0" max="10" />
      </div>

      <div class="input-group">
        <label for="lifeExpectancy">Life Expectancy (years):</label>
        <input
          type="number"
          id="lifeExpectancy"
          value="80"
          step="1"
          min="1"
          max="120"
        />
      </div>

      <div class="input-group">
        <label for="medianAge">Median Age (years):</label>
        <input
          type="number"
          id="medianAge"
          value="38.8"
          step="1"
          min="0"
          max="120"
        />
      </div>

      <div class="input-group">
        <label for="standardDeviation"
          >Standard Deviation from median age (years):</label
        >
        <input
          type="number"
          id="standardDeviation"
          value="13.4"
          step="1"
          min="0"
          max="60"
        />
      </div>

      <div class="input-group">
        <label for="years">Years to Project:</label>
        <input type="number" id="years" value="100" min="1" max="300" />
      </div>

      <button onclick="simulatePopulation()">Simulate Population</button>
    </div>

    <div class="results" id="results" style="display: none">
      <h2>Projection Summary</h2>
      <div class="result-item">
        <strong>Final Population:</strong> <span id="finalPop"></span>
      </div>
      <div class="result-item">
        <strong>Total Change:</strong> <span id="change"></span>
      </div>
      <div class="result-item">
        <strong>Percentage Change:</strong> <span id="pctChange"></span>
      </div>
    </div>

    <div class="chart-container">
      <h2>Population Trend</h2>
      <canvas id="populationChart"></canvas>
    </div>

    <script>
      /**
       * @name calculatePDFCount
       * @description Calculates the expected frequency map (population count) for ages
       * from 0 to 119 directly using the Normal Distribution's PDF,
       * eliminating the need for millions of random number generations.
       *
       * @param {number} mean - The desired mean (center/median) of the population.
       * @param {number} stdDev - The desired standard deviation (spread) of the population.
       * @param {number} size - The total number of data points (people) to generate (e.g., 300,000,000).
       * @returns {Object<number, number>} An object where keys are the age (0-119) and values
       * are the rounded count of people at that age.
       */
      function generateNormalPopulationMap(mean, stdDev, size) {
        const ageMap = {};
        const MIN_AGE = 0;
        const MAX_AGE = 119;
        const TWO_PI_SQRT = Math.sqrt(2 * Math.PI); // Pre-calculate sqrt(2*pi)

        // The Normal Distribution's Probability Density Function (PDF)
        // PDF(x) = (1 / (stdDev * sqrt(2*pi))) * e^(-0.5 * ((x - mean) / stdDev)^2)

        // We can pre-calculate the leading constant
        const pdf_constant = 1.0 / (stdDev * TWO_PI_SQRT);

        // --- 1. Calculate the raw (un-normalized) PDF value for each age ---
        let total_pdf_sum = 0;
        const raw_pdf_values = {};

        // Loop only over the 120 age buckets (0 to 119)
        for (let age = MIN_AGE; age <= MAX_AGE; age++) {
          // Z-score calculation: how many standard deviations is this age from the mean?
          const z = (age - mean) / stdDev;

          // PDF core: e^(-0.5 * Z^2)
          // Use Math.exp() for e^()
          const pdf_core = Math.exp(-0.5 * z * z);

          // Full PDF value for this age
          const pdf_value = pdf_constant * pdf_core;

          raw_pdf_values[age] = pdf_value;
          total_pdf_sum += pdf_value;
        }

        // --- 2. Normalize and Scale the counts ---
        let people_remaining = size; // Track the total count to ensure it exactly equals `size`

        // The sum of all PDF values over the discrete range [0, 119] is total_pdf_sum.
        // We use this to normalize the counts so that they sum up to 'size'.

        for (let age = MIN_AGE; age <= MAX_AGE; age++) {
          const raw_pdf = raw_pdf_values[age];

          // Calculate the proportion (how much this age contributes to the total)
          const proportion = raw_pdf / total_pdf_sum;

          // Calculate the expected count
          // We use Math.floor() here to save the rounding for the last step and keep totals accurate
          const expected_count = Math.floor(proportion * size);

          ageMap[age] = expected_count;
          people_remaining -= expected_count;
        }

        // --- 3. Final Adjustment (To ensure the total count is exactly 'size') ---
        // The floor() operation above might leave a small remainder (people_remaining).
        // We distribute this remainder, one person at a time, to the ages with the highest
        // *fractional* remainder before they were floored.

        // In a simpler approach for a bell curve, we can just add the remainder to the age
        // closest to the mean, which is statistically the most robust bin.
        const closest_age_to_mean = Math.round(mean);
        const final_adjust_age = Math.max(
          MIN_AGE,
          Math.min(MAX_AGE, closest_age_to_mean)
        );

        // If the remainder is positive, add it to the most prominent age group.
        if (people_remaining > 0) {
          // Ensure the age bucket exists if it wasn't populated due to Math.floor(0)
          ageMap[final_adjust_age] =
            (ageMap[final_adjust_age] || 0) + people_remaining;
        }

        // Note: The keys of the object will be strings, as is standard for JavaScript object keys.
        return ageMap;
      }

      let populationChart = null;
      // Define dark mode colors for Chart.js
      const chartAccentColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--color-accent")
        .trim();
      const chartTextColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--color-text-primary")
        .trim();
      const chartGridColor =
        getComputedStyle(document.documentElement)
          .getPropertyValue("--color-border")
          .trim() + "80"; // Add transparency

      // --- New Formatting Functions ---

      // Formats a number with locale-specific thousands separators (commas in en-US)
      function formatNumberWithCommas(n) {
        // Use the built-in Number.prototype.toLocaleString for robust, locale-aware formatting
        return Number(n).toLocaleString(undefined, {
          maximumFractionDigits: 0,
        });
      }

      // Cleans an input string, removing all non-digit characters except an optional leading sign
      function cleanNumberString(s) {
        return s.replace(/[^\d]/g, ""); // Remove all non-digits
      }

      // Handler for the Initial Population input field
      function handleInitialPopulationInput(event) {
        const inputElement = event.target;
        const rawValue = cleanNumberString(inputElement.value);

        // Store the raw, clean numeric value in the data attribute for calculations
        inputElement.setAttribute("data-number-value", rawValue);

        if (rawValue) {
          // Format the display value with commas
          inputElement.value = formatNumberWithCommas(rawValue);
        } else {
          // Keep the field clear if the user deletes all content
          inputElement.value = "";
        }
      }

      // --- End New Formatting Functions ---

      function simulatePopulation() {
        //step 1: Get input values
        const initialPopInput = document.getElementById("initialPopulation");

        //standard deviation: 13.4 years
        const initialPopulation = parseInt(
          initialPopInput.getAttribute("data-number-value")
        );
        const tfr = parseFloat(document.getElementById("tfr").value);
        const lifeExpectancy = parseInt(
          document.getElementById("lifeExpectancy").value
        );
        const medianAge = parseInt(document.getElementById("medianAge").value);
        const years = parseInt(document.getElementById("years").value);
        const stdDev = parseInt(
          document.getElementById("standardDeviation").value
        );
        //step 2: Generate initial population age distribution
        let populationAges = generateNormalPopulationMap(
          medianAge,
          stdDev,
          initialPopulation
        );

        //console log the population ages
        console.log(populationAges);
      }

      // --- Initialization Logic ---
      window.onload = () => {
        const initialPopInput = document.getElementById("initialPopulation");

        // 1. Initial format of the default value
        initialPopInput.value = formatNumberWithCommas(
          initialPopInput.getAttribute("data-number-value")
        );

        // 2. Add event listeners for dynamic formatting
        initialPopInput.addEventListener("input", handleInitialPopulationInput);
        initialPopInput.addEventListener("blur", handleInitialPopulationInput); // Ensures it's formatted when focus is lost

        // 3. Run the initial simulation with the newly formatted value
        simulatePopulation();
      };
    </script>
  </body>
</html>
