<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Population Projection Calculator - Dark Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Modern Dark Mode Color Variables */
      :root {
        --color-background-body: #121212;
        --color-background-card: #1e1e1e;
        --color-text-primary: #e0e0e0;
        --color-text-secondary: #b3b3b3;
        --color-accent: #00bcd4; /* Cyan/Teal for modern look */
        --color-accent-hover: #00a4b8;
        --color-border: #333333;
        --color-input-bg: #2d2d2d;
        --color-result-item-bg: #282828;
        --color-shadow: rgba(0, 0, 0, 0.5);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 30px 20px;
        background-color: var(--color-background-body);
        color: var(--color-text-primary);
        line-height: 1.6;
      }

      .calculator,
      .results,
      .chart-container {
        background: var(--color-background-card);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--color-shadow);
        margin-bottom: 25px;
        transition: box-shadow 0.3s ease;
      }

      h1,
      h2 {
        color: var(--color-accent);
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 10px;
        margin-top: 0;
      }

      p {
        color: var(--color-text-secondary);
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 1rem;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        box-sizing: border-box;
        background-color: var(--color-input-bg);
        color: var(--color-text-primary);
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      input:focus {
        border-color: var(--color-accent);
        outline: none;
      }

      button {
        width: 100%;
        background-color: var(--color-accent);
        color: var(--color-background-card);
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.1s;
      }

      button:hover {
        background-color: var(--color-accent-hover);
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      .result-item {
        margin: 12px 0;
        padding: 15px;
        background: var(--color-result-item-bg);
        border-left: 5px solid var(--color-accent);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .result-item strong {
        font-weight: 600;
      }

      .result-item span {
        font-weight: bold;
        color: var(--color-accent);
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <h1>Population Projection Calculator</h1>
      <p>
        This tool projects population change using Total Fertility Rate (TFR),
        Life Expectancy, and Median Age. It models population aging and births
        directly â€” no crude birth/death rates are used.
      </p>

      <div class="input-group">
        <label for="initialPopulation">Initial Population:</label>
        <input
          type="text"
          id="initialPopulation"
          value="1,000,000"
          data-number-value="1000000"
        />
      </div>

      <div class="input-group">
        <label for="tfr">Total Fertility Rate (children per woman):</label>
        <input type="number" id="tfr" value="2.1" step="0.1" min="0" max="10" />
      </div>

      <div class="input-group">
        <label for="lifeExpectancy">Life Expectancy (years):</label>
        <input
          type="number"
          id="lifeExpectancy"
          value="80"
          step="1"
          min="1"
          max="120"
        />
      </div>

      <div class="input-group">
        <label for="medianAge">Median Age (years):</label>
        <input
          type="number"
          id="medianAge"
          value="35"
          step="1"
          min="0"
          max="120"
        />
      </div>

      <div class="input-group">
        <label for="years">Years to Project:</label>
        <input type="number" id="years" value="100" min="1" max="300" />
      </div>

      <button onclick="simulatePopulation()">Simulate Population</button>
    </div>

    <div class="results" id="results" style="display: none">
      <h2>Projection Summary</h2>
      <div class="result-item">
        <strong>Final Population:</strong> <span id="finalPop"></span>
      </div>
      <div class="result-item">
        <strong>Total Change:</strong> <span id="change"></span>
      </div>
      <div class="result-item">
        <strong>Percentage Change:</strong> <span id="pctChange"></span>
      </div>
    </div>

    <div class="chart-container">
      <h2>Population Trend</h2>
      <canvas id="populationChart"></canvas>
    </div>

    <script>
      // --- Bell Curve Generation ---
      /**
       * Generates an array of numbers that approximate a normal distribution (bell curve).
       *
       * @param {number} mean - The desired mean (center/median) of the population.
       * @param {number} stdDev - The desired standard deviation (spread) of the population.
       * @param {number} size - The number of data points to generate.
       * @returns {number[]} An array of 'size' numbers centered around 'mean' with 'stdDev' spread.
       */
      function generateNormalPopulation(mean, stdDev, size) {
        const population = [];

        // The Box-Muller Transform is used here to generate normally distributed random numbers
        // from two uniformly distributed random numbers (Math.random()).
        // It processes two numbers per iteration, so we handle the 'size' carefully.

        let phase = 0;
        let Z0, Z1; // The two generated normal random variables

        for (let i = 0; i < size; i++) {
          let rand_val;

          if (phase === 0) {
            // Phase 0: Generate two new standard normal variables (Z0, Z1)
            let U1 = Math.random();
            let U2 = Math.random();

            // Calculate Z0 and Z1 using the Box-Muller transform
            Z0 = Math.sqrt(-2.0 * Math.log(U1)) * Math.cos(2.0 * Math.PI * U2);
            Z1 = Math.sqrt(-2.0 * Math.log(U1)) * Math.sin(2.0 * Math.PI * U2);

            // The standard normal variable Z0 has a mean of 0 and stdDev of 1.
            // Convert Z0 to the desired distribution (mean and stdDev)
            rand_val = Z0 * stdDev + mean;
          } else {
            // Phase 1: Use the second generated variable Z1 from the previous iteration
            // Convert Z1 to the desired distribution (mean and stdDev)
            rand_val = Z1 * stdDev + mean;
          }

          // Toggle the phase for the next iteration
          phase = 1 - phase;

          population.push(rand_val);
        }

        // If the size was odd, the last number (generated in phase 0) is already pushed.
        // If the size was even, the last number (generated in phase 1) is already pushed.

        return population;
      }

      let populationChart = null;
      // Define dark mode colors for Chart.js
      const chartAccentColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--color-accent")
        .trim();
      const chartTextColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--color-text-primary")
        .trim();
      const chartGridColor =
        getComputedStyle(document.documentElement)
          .getPropertyValue("--color-border")
          .trim() + "80"; // Add transparency

      // --- New Formatting Functions ---

      // Formats a number with locale-specific thousands separators (commas in en-US)
      function formatNumberWithCommas(n) {
        // Use the built-in Number.prototype.toLocaleString for robust, locale-aware formatting
        return Number(n).toLocaleString(undefined, {
          maximumFractionDigits: 0,
        });
      }

      // Cleans an input string, removing all non-digit characters except an optional leading sign
      function cleanNumberString(s) {
        return s.replace(/[^\d]/g, ""); // Remove all non-digits
      }

      // Handler for the Initial Population input field
      function handleInitialPopulationInput(event) {
        const inputElement = event.target;
        const rawValue = cleanNumberString(inputElement.value);

        // Store the raw, clean numeric value in the data attribute for calculations
        inputElement.setAttribute("data-number-value", rawValue);

        if (rawValue) {
          // Format the display value with commas
          inputElement.value = formatNumberWithCommas(rawValue);
        } else {
          // Keep the field clear if the user deletes all content
          inputElement.value = "";
        }
      }

      // --- End New Formatting Functions ---

      function simulatePopulation() {
        //step 1: Get input values
        const initialPopInput = document.getElementById("initialPopulation");

        //standard deviation: 13.4 years
        const initialPopulation = parseInt(
          initialPopInput.getAttribute("data-number-value")
        );
        const tfr = parseFloat(document.getElementById("tfr").value);
        const lifeExpectancy = parseInt(
          document.getElementById("lifeExpectancy").value
        );
        const medianAge = parseInt(document.getElementById("medianAge").value);
        const years = parseInt(document.getElementById("years").value);
        const stdDev = 13.4;
        //step 2: Generate initial population age distribution
        let populationAges = generateNormalPopulation(
          medianAge,
          stdDev,
          initialPopulation
        );

        print(populationAges);
      }

      // --- Initialization Logic ---
      window.onload = () => {
        const initialPopInput = document.getElementById("initialPopulation");

        // 1. Initial format of the default value
        initialPopInput.value = formatNumberWithCommas(
          initialPopInput.getAttribute("data-number-value")
        );

        // 2. Add event listeners for dynamic formatting
        initialPopInput.addEventListener("input", handleInitialPopulationInput);
        initialPopInput.addEventListener("blur", handleInitialPopulationInput); // Ensures it's formatted when focus is lost

        // 3. Run the initial simulation with the newly formatted value
        simulatePopulation();
      };
    </script>
  </body>
</html>
