<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Population Projection Calculator - Dark Mode</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Modern Dark Mode Color Variables */
      :root {
        --color-background-body: #121212;
        --color-background-card: #1e1e1e;
        --color-text-primary: #e0e0e0;
        --color-text-secondary: #b3b3b3;
        --color-accent: #00bcd4; /* Cyan/Teal for modern look */
        --color-accent-hover: #00a4b8;
        --color-border: #333333;
        --color-input-bg: #2d2d2d;
        --color-result-item-bg: #282828;
        --color-shadow: rgba(0, 0, 0, 0.5);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 30px 20px;
        background-color: var(--color-background-body);
        color: var(--color-text-primary);
        line-height: 1.6;
      }

      .calculator,
      .results,
      .chart-container {
        background: var(--color-background-card);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--color-shadow);
        margin-bottom: 25px;
        transition: box-shadow 0.3s ease;
      }

      h1,
      h2 {
        color: var(--color-accent);
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 10px;
        margin-top: 0;
      }

      p {
        color: var(--color-text-secondary);
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 1rem;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        box-sizing: border-box;
        background-color: var(--color-input-bg);
        color: var(--color-text-primary);
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      input:focus {
        border-color: var(--color-accent);
        outline: none;
      }

      button {
        width: 100%;
        background-color: var(--color-accent);
        color: var(--color-background-card);
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.1s;
      }

      button:hover {
        background-color: var(--color-accent-hover);
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      .result-item {
        margin: 12px 0;
        padding: 15px;
        background: var(--color-result-item-bg);
        border-left: 5px solid var(--color-accent);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .result-item strong {
        font-weight: 600;
      }

      .result-item span {
        font-weight: bold;
        color: var(--color-accent);
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <h1>Population Projection Calculator</h1>
      <p>
        This tool projects population change using Total Fertility Rate (TFR),
        Life Expectancy, and Median Age. It models population aging and births
        directly â€” no crude birth/death rates are used.
      </p>

      <div class="input-group">
        <label for="initialPopulation">Initial Population:</label>
        <input
          type="text"
          id="initialPopulation"
          value="300,000,000"
          data-number-value="300000000"
        />
      </div>

      <div class="input-group">
        <label for="tfr">Total Fertility Rate (children per woman):</label>
        <input type="number" id="tfr" value="2.1" step="0.1" min="0" max="10" />
      </div>

      <div class="input-group">
        <label for="lifeExpectancy">Life Expectancy (years):</label>
        <input
          type="number"
          id="lifeExpectancy"
          value="80"
          step="0.1"
          min="1"
          max="120"
        />
      </div>

      <div class="input-group">
        <label for="medianAge">Median Age (years):</label>
        <input
          type="number"
          id="medianAge"
          value="38.8"
          step="0.1"
          min="0"
          max="120"
        />
      </div>

      <div class="input-group">
        <label for="standardDeviation"
          >Standard Deviation from median age (years):</label
        >
        <input
          type="number"
          id="standardDeviation"
          value="13.4"
          step="0.1"
          min="0"
          max="60"
        />
      </div>

      <div class="input-group">
        <label for="percentMaleAtBirth">Percentage of males at birth:</label>
        <input
          type="number"
          id="percentMaleAtBirth"
          value="51.2"
          step="0.1"
          min="0"
          max="100"
        />
      </div>

      <div class="input-group">
        <label for="years">Years to Project:</label>
        <input type="number" id="years" value="100" min="1" max="300" />
      </div>

      <button onclick="simulatePopulation()">Simulate Population</button>
    </div>

    <div class="results" id="results" style="display: none">
      <h2>Projection Summary</h2>
      <div class="result-item">
        <strong>Final Population:</strong> <span id="finalPop"></span>
      </div>
      <div class="result-item">
        <strong>Total Change:</strong> <span id="change"></span>
      </div>
      <div class="result-item">
        <strong>Percentage Change:</strong> <span id="pctChange"></span>
      </div>
    </div>

    <div class="chart-container">
      <h2>Population Trend</h2>
      <canvas id="populationChart"></canvas>
    </div>

    <script>
      function generateGenderedPopulationMap(
        mean,
        stdDev,
        size,
        maleBirthPercentage
      ) {
        const ageMap = {};
        const MIN_AGE = 0;
        const MAX_AGE = 119;
        const TWO_PI_SQRT = Math.sqrt(2 * Math.PI);

        const maleRatio = maleBirthPercentage / 100;
        const femaleRatio = 1 - maleRatio;

        // PDF Constant calculation
        const pdf_constant = 1.0 / (stdDev * TWO_PI_SQRT);

        // --- 1. Calculate PDF values ---
        let total_pdf_sum = 0;
        const raw_pdf_values = {};

        for (let age = MIN_AGE; age <= MAX_AGE; age++) {
          const z = (age - mean) / stdDev;
          const pdf_value = pdf_constant * Math.exp(-0.5 * z * z);

          raw_pdf_values[age] = pdf_value;
          total_pdf_sum += pdf_value;
        }

        // --- 2. Normalize, Scale, and Split by Gender ---
        let total_assigned = 0;

        for (let age = MIN_AGE; age <= MAX_AGE; age++) {
          const proportion = raw_pdf_values[age] / total_pdf_sum;
          const total_at_age = Math.floor(proportion * size);

          // Split the total at this age by the birth percentage
          const males = Math.round(total_at_age * maleRatio);
          const females = total_at_age - males;

          ageMap[age] = { m: males, f: females };
          total_assigned += males + females;
        }

        // --- 3. Final Adjustment ---
        // If size is 10,000, we ensure exactly 10,000 people are created
        let people_remaining = size - total_assigned;

        if (people_remaining !== 0) {
          const adjustAge = Math.max(
            MIN_AGE,
            Math.min(MAX_AGE, Math.round(mean))
          );

          // Distribute remaining people to the mean age, maintaining ratio
          const extra_males = Math.round(people_remaining * maleRatio);
          const extra_females = people_remaining - extra_males;

          ageMap[adjustAge].m += extra_males;
          ageMap[adjustAge].f += extra_females;
        }

        return ageMap;
      }

      /**
       * Helper function to retrieve death rates from the loaded JSON data.
       * @param {number} age - The current age bucket.
       * @param {string} gender - "Male" or "Female".
       * @param {object} lifeExpectancyData - The parsed JSON data.
       */
      function getDeathRateForAge(age, gender, lifeExpectancyData) {
        // Ensure we don't go out of bounds of the data
        const safeAge = Math.min(age, 119);

        try {
          // Access data: lifeExpectancyData["Male"][age]
          const rate = lifeExpectancyData[gender][safeAge];
          return rate !== undefined ? rate : 0.01; // Default fallback rate
        } catch (e) {
          return 0.01; // Fallback if structure is missing
        }
      }

      let populationChart = null;
      // Define dark mode colors for Chart.js
      const chartAccentColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--color-accent")
        .trim();
      const chartTextColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--color-text-primary")
        .trim();
      const chartGridColor =
        getComputedStyle(document.documentElement)
          .getPropertyValue("--color-border")
          .trim() + "80"; // Add transparency

      // --- New Formatting Functions ---

      // Formats a number with locale-specific thousands separators (commas in en-US)
      function formatNumberWithCommas(n) {
        // Use the built-in Number.prototype.toLocaleString for robust, locale-aware formatting
        return Number(n).toLocaleString(undefined, {
          maximumFractionDigits: 0,
        });
      }

      // Cleans an input string, removing all non-digit characters except an optional leading sign
      function cleanNumberString(s) {
        return s.replace(/[^\d]/g, ""); // Remove all non-digits
      }

      // Handler for the Initial Population input field
      function handleInitialPopulationInput(event) {
        const inputElement = event.target;
        const rawValue = cleanNumberString(inputElement.value);

        // Store the raw, clean numeric value in the data attribute for calculations
        inputElement.setAttribute("data-number-value", rawValue);

        if (rawValue) {
          // Format the display value with commas
          inputElement.value = formatNumberWithCommas(rawValue);
        } else {
          // Keep the field clear if the user deletes all content
          inputElement.value = "";
        }
      }

      // --- End New Formatting Functions ---

      async function simulatePopulation() {
        //step 1: Get input values
        const initialPopInput = document.getElementById("initialPopulation");

        const initialPopulation = parseInt(
          initialPopInput.getAttribute("data-number-value")
        );
        const tfr = parseFloat(document.getElementById("tfr").value);
        const lifeExpectancy = parseInt(
          document.getElementById("lifeExpectancy").value
        );
        const medianAge = parseInt(document.getElementById("medianAge").value);
        const yearsToSimulate = parseInt(
          document.getElementById("years").value
        );
        const stdDev = parseInt(
          document.getElementById("standardDeviation").value
        );
        const percentMaleAtBirth = parseInt(
          document.getElementById("percentMaleAtBirth").value
        );

        let life_expectancy;
        try {
          const response = await fetch("life_expectancy.json");
          life_expectancy = await response.json();
        } catch (e) {
          console.error(
            "Could not load life_expectancy.json. Ensure it's in the same folder.",
            e
          );
          return;
        }

        //step 2: Generate initial population age distribution
        let population = generateGenderedPopulationMap(
          medianAge,
          stdDev,
          initialPopulation,
          percentMaleAtBirth
        );

        //console log the population ages
        //console.log(population);

        //step 3: Simulate year by year
        //if we double loop it, thats 120 ages * years number of calculations
        for (let i = 0; i < yearsToSimulate; i++) {
          let childrenBornThisYear = 0;

          for (const age in population) {
            if (Object.prototype.hasOwnProperty.call(population, age)) {
              // Access the female count from our new object structure { m: #, f: # }
              const womenAtAge = population[age].f;
              const ageNum = parseInt(age);

              // --- Fertility Logic ---
              // If TFR is 2.1, a woman has 1 child at 20, 1 at 21, and 0.1 at 22.
              // We calculate how many "children per woman" are allocated to this specific age.

              const yearsSinceFertilityStart = ageNum - 20;
              let birthsPerWomanThisYear = 0;

              if (yearsSinceFertilityStart >= 0) {
                const remainingTFR = tfr - yearsSinceFertilityStart;

                if (remainingTFR >= 1) {
                  birthsPerWomanThisYear = 1;
                } else if (remainingTFR > 0) {
                  birthsPerWomanThisYear = remainingTFR;
                }
              }

              // Add to the total birth pool
              childrenBornThisYear += womenAtAge * birthsPerWomanThisYear;
            }
          }

          console.log(
            `Year ${i + 1}: Total children born: ${Math.round(
              childrenBornThisYear
            )}`
          );

          //now that we know how many kids were born, we age the population
          // 1. Create a new population object for the next year
          const nextYearPopulation = {};

          // Initialize all buckets from 0 to 119 with zero counts
          for (let i = 0; i <= 119; i++) {
            nextYearPopulation[i] = { m: 0, f: 0 };
          }

          // 2. Add the newborns to age 0
          const maleNewborns = Math.round(
            childrenBornThisYear * (percentMaleAtBirth / 100)
          );
          const femaleNewborns =
            Math.round(childrenBornThisYear) - maleNewborns;
          nextYearPopulation[0] = { m: maleNewborns, f: femaleNewborns };

          // 3. Age the existing population
          for (const age in population) {
            if (Object.prototype.hasOwnProperty.call(population, age)) {
              const ageNum = parseInt(age);
              const currentGroup = population[age];

              // Skip if we are at the max age (they "pass away" or leave the simulation)
              if (ageNum >= 119) continue;

              // Calculate survivors for Males
              const maleDeathRate = getDeathRateForAge(
                ageNum,
                "Male",
                life_expectancy
              );
              const maleSurvivors = Math.round(
                currentGroup.m * (1 - maleDeathRate)
              );

              // Calculate survivors for Females
              const femaleDeathRate = getDeathRateForAge(
                ageNum,
                "Female",
                life_expectancy
              );
              const femaleSurvivors = Math.round(
                currentGroup.f * (1 - femaleDeathRate)
              );

              // Move survivors to the next age bucket
              nextYearPopulation[ageNum + 1].m += maleSurvivors;
              nextYearPopulation[ageNum + 1].f += femaleSurvivors;
            }
          }

          // 4. Overwrite the old population with the new one for the next year of simulation
          population = nextYearPopulation;
        } //end of year loop

        console.log(population);
      }

      // --- Initialization Logic ---
      window.onload = async () => {
        const initialPopInput = document.getElementById("initialPopulation");

        // 1. Initial format of the default value
        initialPopInput.value = formatNumberWithCommas(
          initialPopInput.getAttribute("data-number-value")
        );

        // 2. Add event listeners for dynamic formatting
        initialPopInput.addEventListener("input", handleInitialPopulationInput);
        initialPopInput.addEventListener("blur", handleInitialPopulationInput); // Ensures it's formatted when focus is lost

        // 3. Run the initial simulation with the newly formatted value
        simulatePopulation();
      };
    </script>
  </body>
</html>
